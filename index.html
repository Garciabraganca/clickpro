<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>ClikPro WhatsApp Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
    }
    #chat {
      max-width: 600px;
      margin: 40px auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .messages {
      height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 10px;
      background: #fafafa;
    }
    .message {
      margin-bottom: 10px;
    }
    .message.user {
      text-align: left;
      color: #333;
    }
    .message.ai {
      text-align: right;
      color: #007bff;
    }
    .message.agent {
      text-align: right;
      color: #28a745;
    }
    input, button {
      padding: 10px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div id="chat">
    <h2>ClikPro Assistente WhatsApp</h2>
    <div>
      <label for="phone">Telefone (E.164 sem "+"):</label><br />
      <input id="phone" type="text" placeholder="5511999999999" style="width: 100%; margin-bottom: 10px;" />
    </div>
    <div class="messages" id="messages"></div>
    <input id="messageInput" type="text" placeholder="Digite sua mensagem..." style="width: 80%;" />
    <button id="sendBtn">Enviar</button>
  </div>
  <script>
    const messagesEl = document.getElementById('messages');
    const phoneInput = document.getElementById('phone');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');

    sendBtn.onclick = sendMessage;
    messageInput.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    function renderMessages(msgs) {
      messagesEl.innerHTML = '';
      msgs.forEach((m) => {
        const div = document.createElement('div');
        div.className = 'message ' + m.role;
        let prefix = '';
        if (m.role === 'user') prefix = 'Usuário: ';
        else if (m.role === 'ai') prefix = 'Assistente: ';
        else prefix = 'Você: ';
        div.textContent = prefix + m.content;
        messagesEl.appendChild(div);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function fetchMessages() {
      const phone = phoneInput.value.trim();
      if (!phone) return;
      fetch('/messages?phone=' + phone)
        .then((res) => res.json())
        .then(renderMessages)
        .catch((err) => console.error(err));
    }

    function sendMessage() {
      const phone = phoneInput.value.trim();
      const message = messageInput.value.trim();
      if (!phone || !message) {
        alert('Informe telefone e mensagem.');
        return;
      }
      fetch('/send-message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone, message }),
      })
        .then((res) => {
          if (!res.ok) throw new Error('Erro ao enviar');
          messageInput.value = '';
          fetchMessages();
        })
        .catch((err) => {
          alert(err.message);
        });
    }

    // Atualiza o chat a cada 3 segundos
    setInterval(fetchMessages, 3000);
  </script>
</body>
</html>